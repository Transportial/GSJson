name: Release

on:
  push:
    tags:
      - develop
      - 'v*'

jobs:
  release:
    name: Make GitHub release and publish to Maven Central
    environment: release
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'


    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@417ae3ccd767c252f5661f1ace9f835f9654f2b5 # v3.1.0

    - name: Test, Publish, and Release to Maven Central
      if: success()
      # The 'publishToMavenCentral' task is created by the plugin and handles the full lifecycle.
      # It depends on 'test' and 'build', so they will run automatically.
      run: ./gradlew test publishToMavenCentral --no-daemon
      env:
        MAVEN_USERNAME: ${{ secrets.CENTRAL_TOKEN_USERNAME }}
        MAVEN_PASSWORD: ${{ secrets.CENTRAL_TOKEN_PASSWORD }}
        MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_SIGNING_KEY_PASSWORD }}
